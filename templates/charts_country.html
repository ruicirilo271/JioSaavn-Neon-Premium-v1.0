<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Top 50 â€” {{ country_name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

<div class="container">

    <a class="back" href="/">â¬… Voltar</a>

    <h1>ðŸ‡ºðŸ‡³ Top 50 â€” {{ country_name }}</h1>

    <div class="center">
        <button class="play-all" onclick="playTopCountryAll()">
            â–¶ OUVIR TUDO
        </button>
    </div>

    <ul id="chartList" class="chart-list"></ul>

</div>

{% include 'spotify_player.html' %}

<script src="/static/script.js"></script>
<script src="/static/player.js"></script>

<script>
/* ============================================================
   CARREGAR TOP DO PAÃS + RENDERIZAR
   ============================================================ */

let COUNTRY = "{{ country_code }}";
let TOP_COUNTRY = [];

document.addEventListener("DOMContentLoaded", () => {
    fetch(`/api/charts/${COUNTRY}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                document.getElementById("chartList").innerHTML =
                    "<p>Erro ao carregar Top.</p>";
                return;
            }

            renderTopCountry(data.songs);
        });
});


/* ============================================================
   DESENHAR LISTA DO PAÃS
   ============================================================ */
function renderTopCountry(list) {
    const ul = document.getElementById("chartList");
    ul.innerHTML = "";
    TOP_COUNTRY = list;

    list.forEach((song, i) => {
        const li = document.createElement("li");
        li.className = "chart-item";

        li.innerHTML = `
            <div class="chart-number">${i + 1}</div>
            <img src="${song.cover}" class="chart-cover">
            <div class="chart-info">
                <strong>${song.track}</strong><br>
                <span>${song.artist}</span>
            </div>
            <button class="chart-play" onclick="playTopCountry(${i})">
                â–¶
            </button>
        `;

        ul.appendChild(li);
    });
}


/* ============================================================
   TOCAR 1 FAIXA
   ============================================================ */
function playTopCountry(i) {
    const s = TOP_COUNTRY[i];

    fetch(`/api/to_saavn?track=${encodeURIComponent(s.track)}&artist=${encodeURIComponent(s.artist)}`)
        .then(r => r.json())
        .then(conv => {
            if (!conv.success) {
                alert("MÃºsica nÃ£o encontrada no Saavn.");
                return;
            }

            queue = [{
                title: conv.title,
                artist: conv.artist,
                url: conv.mp3,
                cover: conv.cover
            }];

            loadSong(0);
        });
}


/* ============================================================
   OUVIR TUDO
   ============================================================ */
function playTopCountryAll() {
    let promises = TOP_COUNTRY.map(item =>
        fetch(`/api/to_saavn?track=${encodeURIComponent(item.track)}&artist=${encodeURIComponent(item.artist)}`)
            .then(r => r.json())
    );

    Promise.all(promises).then(results => {
        queue = results
            .filter(s => s.success)
            .map(s => ({
                title: s.title,
                artist: s.artist,
                url: s.mp3,
                cover: s.cover
            }));

        if (!queue.length) {
            alert("Nenhuma mÃºsica encontrada no Saavn.");
            return;
        }

        loadSong(0);
    });
}
</script>

</body>
</html>
